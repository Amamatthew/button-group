<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="d2l-button-menu.html">
<link rel="import" href="d2l-chomp-behavior.html">

<!--
# D2L Button Group

## Usage
```
<link rel="import" href="d2l-button-group">

<d2l-button-group>
	<template>
		<button is="d2l-button">
		</button>
	</template>
</d2l-button-group>
```
@demo
-->

<dom-module id="d2l-button-group">
	<template strip-whitespace>
		<style>
			:host {
				display: block;

				--d2l-button-group-spacing: 0.5rem;
			}

			:host .button-group,
			:host .button-list {
				display: flex;
				flex-wrap: wrap;
				align-items: stretch;
			}
			:host([can-shrink]) .button-group,
			:host([can-shrink]) .button-list {
				flex-wrap: nowrap;
			}

			:host([can-shrink]) button {
				white-space: normal;
			}

			:host .button-list > button,
			:host .button-list > d2l-dropdown-button {
				margin-right: var(--d2l-button-group-spacing);
			}

			:host .button-list > button:last-child,
			:host .button-list > d2l-dropdown-button:last-child {
				margin-right: var(--d2l-button-group-spacing);
			}

			:host-context([dir="rtl"]) .button-list > button,
			:host-context([dir="rtl"]) .button-list > d2l-dropdown-button {
				margin-right: 0;
				margin-left: var(--d2l-button-group-spacing);
			}

			:host-context([dir="rtl"]) .button-list > button:last-child,
			:host-context([dir="rtl"]) .button-list > d2l-dropdown-button:last-child {
				margin-left: var(--d2l-button-group-spacing);
			}
		</style>
		<content id="buttons" select="template"></content>
		<div class="button-group">
			<div id="list" class="button-list">
			</div>
			<d2l-button-menu id="menu" text="More Actions" mini="[[canShrink]]">
			</d2l-button-menu>
		</div>
	</template>
	<script>
		Polymer({
			is: 'd2l-button-group',

			behaviors: [D2L.PolymerBehaviors.ChompBehavior, Polymer.Templatizer],

			listeners: {
				'd2l-menu-item-select': '_onSelectItem',
				'list.tap': '_onSelectItem'
			},

			_onSelectItem: function(e) {
				if (
					e.type === 'tap' &&
					(
						e.target.parentNode !== this.$.list ||
						!e.target.tagName || e.target.tagName.toLowerCase() !== 'button'
					)
				) {
					return;
				}
				this.fire('d2l-button-group-select', Object.assign({}, e.details, {
					target: e.path[0]
				}));
			},

			chomp: function() {
				this._chomp(Polymer.dom(this.$.list).children, this.$.menu);
			},

			_forwardParentProp: function(prop, value) {
				if (this._listInstance) {
					this._listInstance.__setProperty(prop, value);
				}
			},
			_forwardParentPath: function(path, value) {
				if (this._listInstance) {
					this._listInstance._notifyPath(path, value);
				}
			},

			templatize: function(template) {
				Polymer.Templatizer.templatize.call(this, template);
				var forwardParentProp = template._forwardParentProp;
				this.$.menu.templatize(template);

				/* HACK HACK HACK. _forwardParentProp on template is overridden by second templatize call */
				template._forwardParentProp = (function(orig) {
					return function() {
						forwardParentProp.apply(this, arguments);
						orig.apply(this, arguments);
					};
				})(template._forwardParentProp);
			},

			ready: function() {
				var self = this;
				this._observer = Polymer.dom(this.$.buttons).observeNodes(function() {
					var buttonTemplate = Polymer.dom(self.$.buttons).getDistributedNodes()[0];
					if (buttonTemplate) {
						self.templatize(buttonTemplate);
						self.render();
						self.$.menu.render();
					} else {
						console.warn('d2l-button-group requires a template to be provided'); // eslint-disable-line no-console
					}
				});
			},

			/* Stamps the template into the Local DOM */
			render: function() {
				var listClone = this.stamp({ list: true });

				this._listInstance = listClone;

				var list = Polymer.dom(this.$.list);
				while (list.lastChild) {
					list.removeChild(list.lastChild);
				}

				// Polymer.dom(*).appendChild(#document-fragment) does NOT apply styling correctly
				while (listClone.root.firstChild) {
					list.appendChild(listClone.root.firstChild);
				}

				this.chomp();
			}
		});
	</script>
</dom-module>
