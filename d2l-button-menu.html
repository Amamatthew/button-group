<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-icons/d2l-icon.html">
<link rel="import" href="../d2l-icons/tier1-icons.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-button.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-menu/d2l-menu.html">
<link rel="import" href="../d2l-menu/d2l-menu-item.html">
<link rel="import" href="d2l-templatizer.html">

<!--
# D2L Button Menu

## Usage
```
<link rel="import" href="d2l-button-menu.html">

<d2l-button-menu>
	<template>
		<button is="d2l-button">Stuff</button>
		<d2l-dropdown>
			<d2l-dropdown-button text="[[text]]">
				<d2l-dropdown-menu>
					<d2l-menu label="some menu">
					</d2l-menu>
				</d2l-dropdown-menu>
			</d2l-dropdown-button>
		</d2l-dropdown>
	</template>
</d2l-button-menu>
```

Or to re-use a template, use `templatize` and `render`

The `d2l-button-menu-select` event will be fired when a menu item or sub-menu item
is selected. The selected menuItem is `detail.menuItem`. If the menu item is a
top level menu item, the index is contained in `detail.index`.
-->

<dom-module id="d2l-button-menu">
	<template strip-whitespace>
		<style include="d2l-dropdown-opener-styles">
			:host button > span {
				margin-right: 0.6rem;
			}
			:host-context([dir="rtl"]) button > span {
				margin-left: 0.6rem;
				margin-right: 0;
			}

			:host([mini]) button > span {
				display: none;
			}

			:host([mini]) d2l-dropdown {
				height: 100%;
			}

			:host([mini]) button {
				padding: 0.5rem;
				height: 100%;
			}
		</style>
		<content id="buttons" select="template"></content>
		<d2l-dropdown>
			<button is="d2l-button" class="d2l-dropdown-opener">
				<span>[[text]]</span><d2l-icon icon="d2l-tier1:chevron-down"></d2l-icon>
			</button>
			<d2l-dropdown-menu>
				<d2l-menu id="menu" label="[[text]]"></d2l-menu>
			</d2l-dropdown-menu>
		</d2l-dropdown>
	</template>
	<script>
		Polymer({
			is: 'd2l-button-menu',

			properties: {
				text: String,
				mini: {
					type: Boolean,
					reflectToAttribute: true
				},
				start: {
					type: Number,
					observer: '_refresh'
				}
			},

			behaviors: [D2L.PolymerBehaviors.Templatizer],

			_forwardParentProp: function(prop, value) {
				if (this._instance) {
					this._instance.__setProperty(prop, value);
					this._refresh();
				}
			},
			_forwardParentPath: function(path, value) {
				if (this._instance) {
					this._instance._notifyPath(path, value);
					this._refresh();
				}
			},

			ready: function() {
				var self = this;
				this._observer = Polymer.dom(this.$.buttons).observeNodes(function() {
					var buttonTemplate = Polymer.dom(self.$.buttons).getDistributedNodes()[0];
					if (buttonTemplate) {
						self.templatize(buttonTemplate);
						self.render();
					}
				});
			},

			render: function() {
				var menu = Polymer.dom(this.$.menu);
				this._clean(menu);
				this._instance = this.stamp({ menu: true });
				var items = Polymer.dom(this._instance.root).childNodes;
				this._items = items
					.filter(function(node) {
						return node.nodeType === Node.ELEMENT_NODE;
					})
					.map(this._createMenuItem.bind(this));
				this._refresh();
				this._items
					.forEach(function(item) {
						menu.appendChild(item.menuItem);
					});
			},

			_refresh: function() {
				if (!this._items) {
					return;
				}
				var start = this.start;
				this._items
					.map(this._updateMenuItem.bind(this))
					.forEach(function(node, index) {
						if (index <= start) {
							node.setAttribute('hidden', 'hidden');
						} else {
							node.removeAttribute('hidden');
						}
					});
			},

			/* See ChompBehavior */
			showHideItems: function(start) {
				this.start = start;
			},

			_clean: function(node) {
				while (node.lastChild) {
					node.removeChild(node.lastChild);
				}
			},

			_createMenuItem: function(item) {
				var menuItem, source = item;
				if (item.tagName.toLowerCase() === 'a') {
					menuItem = document.createElement('d2l-menu-item-link');
				} else if (item.tagName.toLowerCase() === 'd2l-dropdown-button') {
					var subMenu = item.querySelector('d2l-menu');
					source = subMenu;
					menuItem = document.createElement('d2l-menu-item');
					Polymer.dom(menuItem).appendChild(subMenu);
				} else {
					menuItem = document.createElement('d2l-menu-item');
				}

				menuItem.addEventListener('d2l-menu-item-select', this._onSelectItem.bind(this, source));
				return {
					menuItem: menuItem,
					source: source
				};
			},

			_updateMenuItem: function(item, index) {
				var menuItem = item.menuItem;
				var source = item.source;
				menuItem.href = source.href;
				menuItem.preventDefault = source.getAttribute('data-prevent-default');
				menuItem.text = source.label || source.textContent;
				menuItem.setAttribute('data-index', index);
				return menuItem;
			},

			_onSelectItem: function(source, e) {
				var index;
				var menuItem = e.target;
				if (menuItem.hasAttribute('data-index')) {
					index = +menuItem.getAttribute('data-index');
					if (isNaN(index)) {
						index = undefined;
					}
				}
				this.fire('d2l-button-menu-select', {
					menuItem: menuItem,
					index: index
				});
				source.click();
			}
		});
	</script>
</dom-module>
